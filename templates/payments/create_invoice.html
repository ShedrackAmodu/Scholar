{% extends 'base.html' %}
{% load static %}

{% block title %}Create Invoice - Payments{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, rgba(123, 44, 191, 0.1), rgba(74, 144, 226, 0.1));
        padding: 40px 0;
        margin-bottom: 40px;
        position: relative;
        overflow: hidden;
        border-radius: 0 0 50px 50px;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: linear-gradient(135deg, var(--primary-pink), var(--secondary-pink));
        border-radius: 50%;
        opacity: 0.1;
        animation: float 15s ease-in-out infinite;
    }

    .page-header::after {
        content: '';
        position: absolute;
        bottom: -50%;
        left: -50%;
        width: 300px;
        height: 300px;
        background: linear-gradient(135deg, var(--secondary-pink), var(--primary-pink));
        border-radius: 50%;
        opacity: 0.1;
        animation: float 20s ease-in-out infinite reverse;
    }

    .page-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        position: relative;
        z-index: 2;
        animation: fadeInUp 0.8s ease;
    }

    .page-breadcrumb {
        position: relative;
        z-index: 2;
        animation: fadeInUp 0.8s ease 0.1s both;
    }

    .page-breadcrumb a {
        color: var(--text-secondary);
        text-decoration: none;
        transition: var(--transition-smooth);
    }

    .page-breadcrumb a:hover {
        color: var(--primary-pink);
    }

    .page-breadcrumb .separator {
        margin: 0 10px;
        color: var(--text-secondary);
    }

    .page-breadcrumb .active {
        color: var(--primary-pink);
        font-weight: 500;
    }

    /* Progress Steps */
    .progress-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 50px;
        position: relative;
        animation: fadeInUp 0.8s ease 0.2s both;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }

    .step:not(:last-child)::before {
        content: '';
        position: absolute;
        top: 30px;
        left: 50%;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-pink), var(--secondary-pink));
        opacity: 0.2;
        z-index: -1;
    }

    .step.completed:not(:last-child)::before {
        opacity: 1;
        background: linear-gradient(90deg, var(--primary-pink), var(--secondary-pink));
        animation: progressFill 1s ease;
    }

    @keyframes progressFill {
        from { width: 0; }
        to { width: 100%; }
    }

    .step-icon {
        width: 60px;
        height: 60px;
        background: var(--card-bg);
        border: 3px solid rgba(123, 44, 191, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 15px;
        font-size: 1.5rem;
        color: var(--text-secondary);
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
    }

    .step.active .step-icon {
        border-color: var(--primary-pink);
        color: var(--primary-pink);
        transform: scale(1.1);
        box-shadow: 0 0 0 5px rgba(123, 44, 191, 0.2);
        animation: pulse 2s infinite;
    }

    .step.completed .step-icon {
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        border-color: transparent;
        color: white;
    }

    .step-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .step-desc {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Form Container */
    .form-container {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: var(--border);
        border-radius: 30px;
        padding: 40px;
        box-shadow: var(--shadow);
        animation: fadeInUp 0.8s ease 0.3s both;
        position: relative;
        overflow: hidden;
    }

    .form-container::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 200px;
        height: 200px;
        background: linear-gradient(135deg, var(--primary-pink), var(--secondary-pink));
        border-radius: 50%;
        opacity: 0.05;
        animation: float 15s ease-in-out infinite;
    }

    .form-section {
        margin-bottom: 40px;
        padding-bottom: 40px;
        border-bottom: var(--border);
    }

    .form-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
    }

    .section-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        margin-right: 15px;
        transform: rotate(-5deg);
        transition: var(--transition-smooth);
    }

    .section-title:hover .section-icon {
        transform: rotate(0deg) scale(1.1);
    }

    .section-title h3 {
        font-size: 1.4rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-primary);
    }

    .section-title p {
        color: var(--text-secondary);
        margin: 5px 0 0;
        font-size: 0.9rem;
    }

    /* Form Fields */
    .form-group {
        margin-bottom: 25px;
        position: relative;
        animation: fadeInUp 0.5s ease;
        animation-fill-mode: both;
    }

    .form-group:nth-child(1) { animation-delay: 0.1s; }
    .form-group:nth-child(2) { animation-delay: 0.15s; }
    .form-group:nth-child(3) { animation-delay: 0.2s; }
    .form-group:nth-child(4) { animation-delay: 0.25s; }
    .form-group:nth-child(5) { animation-delay: 0.3s; }

    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: block;
    }

    .form-label i {
        color: var(--primary-pink);
        margin-right: 8px;
    }

    .form-control, .form-select {
        background: var(--card-bg);
        border: 2px solid rgba(123, 44, 191, 0.1);
        border-radius: 15px;
        padding: 12px 20px;
        color: var(--text-primary);
        transition: var(--transition-smooth);
        width: 100%;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary-pink);
        box-shadow: 0 0 0 5px rgba(123, 44, 191, 0.1);
        transform: translateY(-2px);
    }

    .form-control.is-invalid {
        border-color: var(--danger);
    }

    .invalid-feedback {
        color: var(--danger);
        font-size: 0.85rem;
        margin-top: 5px;
        animation: shake 0.3s ease;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Select2 Customization */
    .select2-container--default .select2-selection--multiple {
        background: var(--card-bg);
        border: 2px solid rgba(123, 44, 191, 0.1);
        border-radius: 15px;
        padding: 5px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        color: white;
        border: none;
        border-radius: 25px;
        padding: 5px 15px;
        margin: 5px;
        animation: slideInRight 0.3s ease;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
    }

    /* Fee Items List */
    .fee-items-list {
        background: rgba(123, 44, 191, 0.05);
        border-radius: 20px;
        padding: 20px;
        margin-top: 20px;
    }

    .fee-item {
        display: flex;
        align-items: center;
        padding: 15px;
        background: var(--card-bg);
        border-radius: 15px;
        margin-bottom: 10px;
        transition: var(--transition-smooth);
        animation: slideInRight 0.3s ease;
    }

    .fee-item:hover {
        transform: translateX(10px);
        box-shadow: var(--shadow);
    }

    .fee-item-check {
        margin-right: 15px;
    }

    .fee-item-check input {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }

    .fee-item-content {
        flex: 1;
    }

    .fee-item-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .fee-item-details {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .fee-item-details span {
        display: flex;
        align-items: center;
    }

    .fee-item-details i {
        color: var(--primary-pink);
        margin-right: 5px;
    }

    .fee-item-amount {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-pink);
        margin-left: 20px;
    }

    /* Summary Card */
    .summary-card {
        background: linear-gradient(135deg, rgba(123, 44, 191, 0.1), rgba(74, 144, 226, 0.1));
        border-radius: 20px;
        padding: 25px;
        position: sticky;
        top: 100px;
        animation: slideInRight 0.8s ease 0.4s both;
    }

    .summary-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text-primary);
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 15px 0;
        border-bottom: var(--border);
    }

    .summary-item:last-child {
        border-bottom: none;
    }

    .summary-label {
        color: var(--text-secondary);
    }

    .summary-value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .summary-total {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-pink);
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px dashed rgba(123, 44, 191, 0.3);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
        padding-top: 30px;
        border-top: var(--border);
        animation: fadeInUp 0.5s ease 0.5s both;
    }

    .btn {
        padding: 12px 30px;
        border-radius: 50px;
        font-weight: 500;
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 10px 25px rgba(123, 44, 191, 0.4);
    }

    .btn-secondary {
        background: transparent;
        border: 2px solid var(--primary-pink);
        color: var(--primary-pink);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
        color: white;
        transform: translateY(-3px);
        border-color: transparent;
    }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes float {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(30px, 30px) rotate(5deg); }
        50% { transform: translate(-20px, 50px) rotate(-5deg); }
        75% { transform: translate(40px, -20px) rotate(3deg); }
    }

    @keyframes pulse {
        0%, 100% { box-shadow: 0 0 0 5px rgba(123, 44, 191, 0.2); }
        50% { box-shadow: 0 0 0 10px rgba(123, 44, 191, 0.4); }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }

        .form-container {
            padding: 25px;
        }

        .progress-steps {
            flex-direction: column;
            gap: 20px;
        }

        .step:not(:last-child)::before {
            display: none;
        }

        .summary-card {
            position: static;
            margin-top: 30px;
        }

        .form-actions {
            flex-direction: column;
        }

        .form-actions .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1 class="page-title gradient-text">
            <i class="fas fa-file-invoice me-3"></i>Create New Invoice
        </h1>
        <div class="page-breadcrumb">
            <a href="{% url 'school:home' %}">Home</a>
            <span class="separator"><i class="fas fa-chevron-right"></i></span>
            <a href="{% url 'accounts:admin_dashboard' %}">Dashboard</a>
            <span class="separator"><i class="fas fa-chevron-right"></i></span>
            <a href="{% url 'payments:fee_categories' %}">Payments</a>
            <span class="separator"><i class="fas fa-chevron-right"></i></span>
            <span class="active">Create Invoice</span>
        </div>
    </div>
</div>

<div class="container mb-5">
    <!-- Progress Steps -->
    <div class="progress-steps">
        <div class="step active" id="step1">
            <div class="step-icon">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="step-label">Step 1</div>
            <div class="step-desc">Select Student</div>
        </div>
        <div class="step" id="step2">
            <div class="step-icon">
                <i class="fas fa-tags"></i>
            </div>
            <div class="step-label">Step 2</div>
            <div class="step-desc">Add Fee Items</div>
        </div>
        <div class="step" id="step3">
            <div class="step-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="step-label">Step 3</div>
            <div class="step-desc">Review & Confirm</div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Main Form -->
            <div class="form-container">
                <form method="post" id="invoiceForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Step 1: Student Information -->
                    <div class="form-section" id="step1-section">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div>
                                <h3>Student Information</h3>
                                <p>Select the student and academic period for this invoice</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-user"></i>Student
                                    </label>
                                    <select class="form-select" name="student" required>
                                        <option value="">Select Student</option>
                                        {% for student in students %}
                                        <option value="{{ student.id }}" 
                                                data-class="{{ student.class_assigned.name }}"
                                                data-admission="{{ student.admission_number }}">
                                            {{ student.user.get_full_name }} ({{ student.admission_number }}) - {{ student.class_assigned.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-alt"></i>Academic Year
                                    </label>
                                    <select class="form-select" name="academic_year" required>
                                        <option value="">Select Academic Year</option>
                                        {% for year in academic_years %}
                                        <option value="{{ year.id }}">{{ year.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-clock"></i>Term
                                    </label>
                                    <select class="form-select" name="term" required>
                                        <option value="">Select Term</option>
                                        <option value="1ST">First Term</option>
                                        <option value="2ND">Second Term</option>
                                        <option value="3RD">Third Term</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-calendar-check"></i>Due Date
                                    </label>
                                    <input type="date" class="form-control" name="due_date" required>
                                </div>
                            </div>
                        </div>

                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-primary" onclick="nextStep(2)">
                                Next Step <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Fee Items -->
                    <div class="form-section" id="step2-section" style="display: none;">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <div>
                                <h3>Fee Items</h3>
                                <p>Select the fees to include in this invoice</p>
                            </div>
                        </div>

                        <div class="fee-items-list">
                            {% for fee in fee_structures %}
                            <div class="fee-item">
                                <div class="fee-item-check">
                                    <input type="checkbox" name="fee_items" value="{{ fee.id }}" 
                                           data-amount="{{ fee.amount }}"
                                           data-name="{{ fee.name }}"
                                           class="fee-checkbox"
                                           onchange="updateSummary()">
                                </div>
                                <div class="fee-item-content">
                                    <div class="fee-item-title">{{ fee.name }}</div>
                                    <div class="fee-item-details">
                                        <span><i class="fas fa-layer-group"></i>{{ fee.category.name }}</span>
                                        <span><i class="fas fa-calendar"></i>{{ fee.get_term_display|default:"All Terms" }}</span>
                                        <span><i class="fas fa-clock"></i>Due: {{ fee.due_date|date:"M d, Y" }}</span>
                                    </div>
                                </div>
                                <div class="fee-item-amount">₦{{ fee.amount|floatformat:2 }}</div>
                            </div>
                            {% empty %}
                            <div class="text-center py-5">
                                <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                                <h5>No Fee Structures Available</h5>
                                <p class="text-muted">Please create fee structures first.</p>
                                <a href="{% url 'payments:fee_categories' %}" class="btn btn-primary">
                                    <i class="fas fa-plus-circle me-2"></i>Create Fee Structures
                                </a>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-percent"></i>Discount (if any)
                                    </label>
                                    <select class="form-select" name="discount" onchange="updateSummary()">
                                        <option value="">No Discount</option>
                                        {% for discount in discounts %}
                                        <option value="{{ discount.id }}" data-percentage="{{ discount.percentage }}">
                                            {{ discount.name }} ({{ discount.percentage }}% off)
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="fas fa-sticky-note"></i>Notes
                                    </label>
                                    <textarea class="form-control" name="notes" rows="3" placeholder="Additional notes for this invoice..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" class="btn btn-secondary" onclick="prevStep(1)">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep(3)">
                                Next Step <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Review & Confirm -->
                    <div class="form-section" id="step3-section" style="display: none;">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div>
                                <h3>Review & Confirm</h3>
                                <p>Review the invoice details before finalizing</p>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded mb-3">
                                    <small class="text-muted d-block">Student</small>
                                    <strong id="review-student">Not selected</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded mb-3">
                                    <small class="text-muted d-block">Academic Year / Term</small>
                                    <strong id="review-academic">Not selected</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded mb-3">
                                    <small class="text-muted d-block">Due Date</small>
                                    <strong id="review-duedate">Not set</strong>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded mb-3">
                                    <small class="text-muted d-block">Discount</small>
                                    <strong id="review-discount">None</strong>
                                </div>
                            </div>
                        </div>

                        <h6 class="mt-4 mb-3">Selected Fee Items:</h6>
                        <div id="selected-fees-list" class="mb-4">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Please review all information carefully before creating the invoice.
                        </div>

                        <div class="d-flex justify-content-between mt-3">
                            <button type="button" class="btn btn-secondary" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check-circle me-2"></i>Create Invoice
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Summary Card -->
            <div class="summary-card">
                <h5 class="summary-title">
                    <i class="fas fa-calculator me-2" style="color: var(--primary-pink);"></i>
                    Invoice Summary
                </h5>

                <div class="summary-item">
                    <span class="summary-label">Subtotal:</span>
                    <span class="summary-value" id="summary-subtotal">₦0.00</span>
                </div>

                <div class="summary-item">
                    <span class="summary-label">Discount:</span>
                    <span class="summary-value" id="summary-discount">₦0.00</span>
                </div>

                <div class="summary-total">
                    <div class="d-flex justify-content-between">
                        <span>Total:</span>
                        <span id="summary-total">₦0.00</span>
                    </div>
                </div>

                <hr class="my-3">

                <div class="text-center">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Invoice will be generated with reference number
                    </small>
                </div>
            </div>

            <!-- Quick Tips Card -->
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-lightbulb me-2" style="color: var(--primary-pink);"></i>
                        Quick Tips
                    </h5>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Select the correct academic year and term
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            You can add multiple fee items
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Discounts are optional
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Review all details before submitting
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentStep = 1;
    const totalSteps = 3;

    // Navigate to next step
    function nextStep(step) {
        if (validateStep(currentStep)) {
            document.getElementById(`step${currentStep}-section`).style.display = 'none';
            document.getElementById(`step${step}-section`).style.display = 'block';
            
            // Update progress steps
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');
            
            if (step > currentStep) {
                for (let i = currentStep; i < step; i++) {
                    document.getElementById(`step${i}`).classList.add('completed');
                }
            }
            
            currentStep = step;
            
            // Update review section if moving to step 3
            if (step === 3) {
                updateReview();
            }
        }
    }

    // Navigate to previous step
    function prevStep(step) {
        document.getElementById(`step${currentStep}-section`).style.display = 'none';
        document.getElementById(`step${step}-section`).style.display = 'block';
        
        document.getElementById(`step${currentStep}`).classList.remove('active');
        document.getElementById(`step${step}`).classList.add('active');
        
        currentStep = step;
    }

    // Validate current step
    function validateStep(step) {
        switch(step) {
            case 1:
                const student = document.querySelector('select[name="student"]').value;
                const academicYear = document.querySelector('select[name="academic_year"]').value;
                const term = document.querySelector('select[name="term"]').value;
                const dueDate = document.querySelector('input[name="due_date"]').value;
                
                if (!student || !academicYear || !term || !dueDate) {
                    showNotification('Please fill in all required fields', 'error');
                    return false;
                }
                return true;
                
            case 2:
                const checkedFees = document.querySelectorAll('.fee-checkbox:checked');
                if (checkedFees.length === 0) {
                    showNotification('Please select at least one fee item', 'error');
                    return false;
                }
                return true;
                
            default:
                return true;
        }
    }

    // Update invoice summary
    function updateSummary() {
        let subtotal = 0;
        const checkedFees = document.querySelectorAll('.fee-checkbox:checked');
        
        checkedFees.forEach(fee => {
            subtotal += parseFloat(fee.dataset.amount);
        });

        // Calculate discount
        let discount = 0;
        const discountSelect = document.querySelector('select[name="discount"]');
        const selectedOption = discountSelect.options[discountSelect.selectedIndex];
        
        if (selectedOption.value) {
            const discountPercentage = parseFloat(selectedOption.dataset.percentage);
            discount = (subtotal * discountPercentage) / 100;
        }

        const total = subtotal - discount;

        // Update summary display
        document.getElementById('summary-subtotal').textContent = `₦${subtotal.toFixed(2)}`;
        document.getElementById('summary-discount').textContent = `₦${discount.toFixed(2)}`;
        document.getElementById('summary-total').textContent = `₦${total.toFixed(2)}`;
    }

    // Update review section
    function updateReview() {
        // Student info
        const studentSelect = document.querySelector('select[name="student"]');
        const selectedStudent = studentSelect.options[studentSelect.selectedIndex];
        document.getElementById('review-student').textContent = selectedStudent.text.split(' - ')[0];

        // Academic info
        const yearSelect = document.querySelector('select[name="academic_year"]');
        const termSelect = document.querySelector('select[name="term"]');
        document.getElementById('review-academic').textContent = 
            `${yearSelect.options[yearSelect.selectedIndex].text} - ${termSelect.options[termSelect.selectedIndex].text}`;

        // Due date
        const dueDate = document.querySelector('input[name="due_date"]').value;
        document.getElementById('review-duedate').textContent = new Date(dueDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Discount
        const discountSelect = document.querySelector('select[name="discount"]');
        const selectedDiscount = discountSelect.options[discountSelect.selectedIndex];
        document.getElementById('review-discount').textContent = selectedDiscount.value ? selectedDiscount.text : 'None';

        // Selected fees
        const selectedFeesList = document.getElementById('selected-fees-list');
        selectedFeesList.innerHTML = '';

        const checkedFees = document.querySelectorAll('.fee-checkbox:checked');
        checkedFees.forEach(fee => {
            const feeItem = document.createElement('div');
            feeItem.className = 'd-flex justify-content-between align-items-center p-2 bg-light rounded mb-2';
            feeItem.innerHTML = `
                <span>${fee.dataset.name}</span>
                <strong>₦${parseFloat(fee.dataset.amount).toFixed(2)}</strong>
            `;
            selectedFeesList.appendChild(feeItem);
        });
    }

    // Initialize form
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for summary updates
        document.querySelectorAll('.fee-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSummary);
        });

        document.querySelector('select[name="discount"]').addEventListener('change', updateSummary);

        // Student selection enhancement
        const studentSelect = document.querySelector('select[name="student"]');
        if (studentSelect) {
            new Choices(studentSelect, {
                removeItemButton: true,
                searchEnabled: true,
                placeholder: true,
                placeholderValue: 'Select Student'
            });
        }

        // Initialize any date pickers
        const dueDateInput = document.querySelector('input[name="due_date"]');
        if (dueDateInput) {
            dueDateInput.min = new Date().toISOString().split('T')[0];
        }
    });

    // Form submission with animation
    document.getElementById('invoiceForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (validateStep(3)) {
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
            submitBtn.disabled = true;
            
            // Submit form
            this.submit();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'ArrowRight') {
            e.preventDefault();
            if (currentStep < totalSteps) {
                nextStep(currentStep + 1);
            }
        }
        
        if (e.ctrlKey && e.key === 'ArrowLeft') {
            e.preventDefault();
            if (currentStep > 1) {
                prevStep(currentStep - 1);
            }
        }
    });

    // Auto-calculate based on student's class
    document.querySelector('select[name="student"]').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const studentClass = selectedOption.dataset.class;
        
        // Filter fee items based on student's class (if needed)
        if (studentClass) {
            // Add your filtering logic here
        }
    });
</script>
{% endblock %}