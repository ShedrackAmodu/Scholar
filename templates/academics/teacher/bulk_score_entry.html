{% extends 'base.html' %}
{% load static %}

{% block title %}Bulk Score Entry - Teacher{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        padding: 50px 0;
        margin-bottom: 40px;
        border-radius: 0 0 50px 50px;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -30%;
        width: 400px;
        height: 400px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 20s ease-in-out infinite;
    }

    .header-content {
        position: relative;
        z-index: 2;
    }

    .header-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 15px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .header-subtitle {
        font-size: 1.1rem;
        opacity: 0.95;
    }

    /* Form Card */
    .form-card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: var(--border);
        border-radius: 30px;
        padding: 40px;
        box-shadow: var(--shadow);
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
    }

    .form-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 30px 60px rgba(108, 92, 231, 0.3);
    }

    .form-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        opacity: 0.05;
        border-radius: 0 0 0 100%;
    }

    .form-header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: var(--border);
    }

    .form-icon {
        width: 60px;
        height: 60px;
        line-height: 60px;
        text-align: center;
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        color: white;
        border-radius: 20px;
        font-size: 1.8rem;
        transition: var(--transition-bounce);
    }

    .form-card:hover .form-icon {
        transform: scale(1.1) rotate(10deg);
    }

    .form-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .form-subtitle {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin: 0;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
    }

    .form-label i {
        color: #6c5ce7;
        width: 20px;
    }

    .form-label.required::after {
        content: '*';
        color: #e17055;
        margin-left: 5px;
    }

    .form-control, .form-select {
        background: var(--card-bg);
        border: 2px solid var(--border);
        border-radius: 15px;
        padding: 15px 20px;
        color: var(--text-primary);
        transition: var(--transition-smooth);
        font-size: 1rem;
    }

    .form-control:focus, .form-select:focus {
        border-color: #6c5ce7;
        box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25);
        transform: translateY(-3px);
        outline: none;
    }

    .form-control.is-invalid {
        border-color: #e17055;
        box-shadow: 0 0 0 0.2rem rgba(225, 112, 85, 0.25);
    }

    .form-control.is-valid {
        border-color: #00b894;
        box-shadow: 0 0 0 0.2rem rgba(0, 184, 148, 0.25);
    }

    .invalid-feedback {
        color: #e17055;
        font-size: 0.85rem;
        margin-top: 5px;
    }

    .valid-feedback {
        color: #00b894;
        font-size: 0.85rem;
        margin-top: 5px;
    }

    .form-text {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin-top: 5px;
    }

    /* Student Selection */
    .student-selection {
        background: rgba(108, 92, 231, 0.05);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 25px;
        border: 2px solid transparent;
    }

    .student-selection.active {
        border-color: #6c5ce7;
        background: rgba(108, 92, 231, 0.1);
    }

    .student-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
    }

    .student-item {
        background: var(--card-bg);
        border: var(--border);
        border-radius: 15px;
        padding: 15px;
        cursor: pointer;
        transition: var(--transition-smooth);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .student-item:hover {
        background: rgba(108, 92, 231, 0.1);
        transform: translateY(-2px);
    }

    .student-item.selected {
        background: linear-gradient(135deg, rgba(108, 92, 231, 0.2), rgba(163, 99, 217, 0.2));
        border-color: #6c5ce7;
        box-shadow: 0 5px 15px rgba(108, 92, 231, 0.2);
    }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .student-info {
        flex: 1;
    }

    .student-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .student-admission {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Scores Input */
    .scores-section {
        background: rgba(108, 92, 231, 0.05);
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        border: 2px solid transparent;
    }

    .scores-section.active {
        border-color: #6c5ce7;
        background: rgba(108, 92, 231, 0.1);
    }

    .scores-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: var(--border);
    }

    .scores-title {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .scores-count {
        background: rgba(108, 92, 231, 0.2);
        color: #6c5ce7;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .scores-input {
        background: var(--card-bg);
        border: var(--border);
        border-radius: 15px;
        padding: 20px;
        min-height: 150px;
        transition: var(--transition-smooth);
    }

    .scores-input:focus-within {
        border-color: #6c5ce7;
        box-shadow: 0 0 0 0.2rem rgba(108, 92, 231, 0.25);
    }

    .scores-input textarea {
        width: 100%;
        height: 120px;
        background: transparent;
        border: none;
        outline: none;
        resize: vertical;
        font-size: 1rem;
        color: var(--text-primary);
        font-family: monospace;
    }

    .scores-format {
        background: rgba(108, 92, 231, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        border-left: 4px solid #6c5ce7;
    }

    .format-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
    }

    .format-example {
        background: var(--card-bg);
        border: var(--border);
        border-radius: 10px;
        padding: 15px;
        font-family: monospace;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    /* Action Buttons */
    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 40px;
        padding-top: 30px;
        border-top: var(--border);
    }

    .btn-submit {
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        color: white;
        padding: 15px 40px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1.1rem;
        border: none;
        cursor: pointer;
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .btn-submit:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 20px 40px rgba(108, 92, 231, 0.4);
    }

    .btn-submit::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
        z-index: 0;
    }

    .btn-submit:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-submit i, .btn-submit span {
        position: relative;
        z-index: 2;
    }

    .btn-cancel {
        background: var(--card-bg);
        border: 2px solid #6c5ce7;
        color: #6c5ce7;
        padding: 15px 40px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: var(--transition-smooth);
    }

    .btn-cancel:hover {
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        color: white;
        transform: translateY(-3px);
    }

    .btn-secondary {
        background: rgba(108, 92, 231, 0.1);
        color: #6c5ce7;
        border: 2px solid rgba(108, 92, 231, 0.3);
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition-smooth);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        color: white;
        transform: translateY(-2px);
    }

    /* Progress Bar */
    .progress-container {
        background: rgba(108, 92, 231, 0.1);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 25px;
        display: none;
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .progress-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .progress-bar {
        height: 10px;
        background: var(--card-bg);
        border: var(--border);
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #6c5ce7, #a363d9);
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        margin-top: 10px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* Results */
    .results-section {
        background: rgba(108, 92, 231, 0.05);
        border-radius: 20px;
        padding: 25px;
        margin-top: 25px;
        display: none;
    }

    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: var(--border);
    }

    .results-title {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 1.1rem;
    }

    .results-stats {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
    }

    .result-stat {
        background: var(--card-bg);
        border: var(--border);
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        min-width: 120px;
    }

    .result-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #6c5ce7;
        margin-bottom: 5px;
    }

    .result-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header-title {
            font-size: 2rem;
        }

        .form-card {
            padding: 25px;
        }

        .student-list {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
        }

        .btn-submit, .btn-cancel {
            width: 100%;
        }

        .results-stats {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="container header-content">
        <h1 class="header-title animate__animated animate__fadeInDown">
            <i class="fas fa-upload me-3"></i>Bulk Score Entry
        </h1>
        <p class="header-subtitle animate__animated animate__fadeInUp">
            Upload scores for multiple students at once using comma-separated values
        </p>
    </div>
</section>

<div class="container">
    <div class="form-card animate__animated animate__fadeInUp">
        <div class="form-header">
            <div class="form-icon">
                <i class="fas fa-upload"></i>
            </div>
            <div>
                <h2 class="form-title">Bulk Score Upload</h2>
                <p class="form-subtitle">Enter scores for selected students in the format: score1, score2, score3, ...</p>
            </div>
        </div>

        <form method="post" id="bulkScoreForm">
            {% csrf_token %}

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required">
                            <i class="fas fa-school"></i>
                            Class
                        </label>
                        {{ form.class_assigned }}
                        {% if form.class_assigned.errors %}
                            <div class="invalid-feedback d-block">{{ form.class_assigned.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Select the class for which you're entering scores</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label required">
                            <i class="fas fa-clipboard-list"></i>
                            Subject Assessment
                        </label>
                        {{ form.subject_assessment }}
                        {% if form.subject_assessment.errors %}
                            <div class="invalid-feedback d-block">{{ form.subject_assessment.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Select the assessment for which you're entering scores</div>
                    </div>
                </div>
            </div>

            <!-- Student Selection -->
            <div class="student-selection" id="studentSelection">
                <div class="scores-header">
                    <div class="scores-title">
                        <i class="fas fa-users me-2"></i>
                        Select Students
                    </div>
                    <div class="scores-count" id="studentCount">
                        0 selected
                    </div>
                </div>
                
                <div class="student-list" id="studentList">
                    {% for student in students %}
                        <div class="student-item" onclick="toggleStudent({{ student.id }})">
                            <div class="student-avatar">
                                {{ forloop.counter }}
                            </div>
                            <div class="student-info">
                                <div class="student-name">{{ student.user.get_full_name }}</div>
                                <div class="student-admission">{{ student.admission_number }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Scores Input -->
            <div class="scores-section" id="scoresSection">
                <div class="scores-header">
                    <div class="scores-title">
                        <i class="fas fa-calculator me-2"></i>
                        Enter Scores
                    </div>
                    <div class="scores-count" id="scoresCount">
                        0 scores
                    </div>
                </div>
                
                <div class="scores-input">
                    {{ form.scores }}
                    {% if form.scores.errors %}
                        <div class="invalid-feedback d-block">{{ form.scores.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="scores-format">
                    <div class="format-title">Format:</div>
                    <div class="format-example">
                        75, 82, 90, 68, 85, 92, 78, 88, 95, 73<br>
                        <small class="text-secondary">Comma-separated scores in the same order as selected students</small>
                    </div>
                </div>
            </div>

            <!-- Remarks -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-comment"></i>
                    Remarks (Optional)
                </label>
                {{ form.remarks }}
                {% if form.remarks.errors %}
                    <div class="invalid-feedback d-block">{{ form.remarks.errors.0 }}</div>
                {% endif %}
                <div class="form-text">Optional remarks about this assessment</div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <div class="progress-title">Uploading Scores...</div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressStatus">Processing...</div>
            </div>

            <!-- Results -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <div class="results-title">
                        <i class="fas fa-check-circle me-2"></i>
                        Upload Results
                    </div>
                    <div class="results-stats">
                        <div class="result-stat">
                            <div class="result-value" id="successCount">0</div>
                            <div class="result-label">Successful</div>
                        </div>
                        <div class="result-stat">
                            <div class="result-value" id="errorCount">0</div>
                            <div class="result-label">Errors</div>
                        </div>
                        <div class="result-stat">
                            <div class="result-value" id="totalCount">0</div>
                            <div class="result-label">Total</div>
                        </div>
                    </div>
                </div>
                <div class="results-content" id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="clearForm()">
                    <i class="fas fa-undo"></i>
                    <span>Clear</span>
                </button>
                <a href="{% url 'academics:score_entry' %}" class="btn-cancel">
                    <i class="fas fa-arrow-left"></i>
                    <span>Cancel</span>
                </a>
                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="fas fa-upload"></i>
                    <span>Upload Scores</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-body p-5">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="modal-title mb-2">Scores Uploaded Successfully!</h4>
                <p class="text-secondary">All scores have been processed and saved to the system.</p>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <a href="{% url 'academics:score_entry' %}" class="btn btn-primary">
                        <i class="fas fa-list me-2"></i>Back to Dashboard
                    </a>
                    <a href="{% url 'academics:bulk_score_entry' %}" class="btn btn-outline-primary">
                        <i class="fas fa-upload me-2"></i>Upload More
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-body p-5">
                <div class="mb-4">
                    <i class="fas fa-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                </div>
                <h4 class="modal-title mb-2">Some Errors Occurred</h4>
                <p class="text-secondary">Some scores could not be processed. Please check the details below.</p>
                <div class="alert alert-warning mt-3" id="errorDetails">
                    <!-- Error details will be populated here -->
                </div>
                <div class="d-flex gap-2 justify-content-center mt-4">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-2"></i>OK
                    </button>
                    <a href="{% url 'academics:bulk_score_entry' %}" class="btn btn-outline-primary">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Student selection functionality
    let selectedStudents = [];
    
    function toggleStudent(studentId) {
        const index = selectedStudents.indexOf(studentId);
        if (index > -1) {
            selectedStudents.splice(index, 1);
        } else {
            selectedStudents.push(studentId);
        }
        
        updateStudentSelection();
        updateScoresCount();
    }
    
    function updateStudentSelection() {
        document.querySelectorAll('.student-item').forEach(item => {
            const studentId = parseInt(item.querySelector('.student-avatar').textContent);
            if (selectedStudents.includes(studentId)) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
        
        document.getElementById('studentCount').textContent = `${selectedStudents.length} selected`;
        
        if (selectedStudents.length > 0) {
            document.getElementById('studentSelection').classList.add('active');
        } else {
            document.getElementById('studentSelection').classList.remove('active');
        }
    }
    
    function updateScoresCount() {
        const scoresInput = document.getElementById('id_scores');
        const scoresText = scoresInput.value;
        const scoreCount = scoresText.split(',').filter(score => score.trim()).length;
        
        document.getElementById('scoresCount').textContent = `${scoreCount} scores`;
        
        if (scoreCount > 0) {
            document.getElementById('scoresSection').classList.add('active');
        } else {
            document.getElementById('scoresSection').classList.remove('active');
        }
    }
    
    // Form validation
    document.getElementById('bulkScoreForm').addEventListener('submit', function(e) {
        let valid = true;
        const requiredFields = ['id_class_assigned', 'id_subject_assessment', 'id_scores'];
        
        requiredFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                field.classList.add('is-invalid');
                valid = false;
            } else {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            }
        });
        
        // Check if students are selected
        if (selectedStudents.length === 0) {
            document.getElementById('studentSelection').style.borderColor = '#e17055';
            valid = false;
        } else {
            document.getElementById('studentSelection').style.borderColor = 'transparent';
        }
        
        // Check if scores match student count
        const scoresText = document.getElementById('id_scores').value;
        const scoreCount = scoresText.split(',').filter(score => score.trim()).length;
        
        if (scoreCount !== selectedStudents.length) {
            document.getElementById('scoresSection').style.borderColor = '#e17055';
            showNotification(`Number of scores (${scoreCount}) doesn't match number of selected students (${selectedStudents.length})`, 'error');
            valid = false;
        } else {
            document.getElementById('scoresSection').style.borderColor = 'transparent';
        }
        
        if (!valid) {
            e.preventDefault();
            showNotification('Please fix the errors above', 'error');
        } else {
            // Show progress
            showProgress();
        }
    });
    
    // Real-time validation
    document.getElementById('id_scores').addEventListener('input', function() {
        updateScoresCount();
        
        // Validate score format
        const scoresText = this.value;
        const scores = scoresText.split(',').map(score => score.trim());
        const validScores = scores.filter(score => {
            const num = parseFloat(score);
            return !isNaN(num) && num >= 0 && num <= 100;
        });
        
        if (validScores.length === scores.length && scores.length > 0) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    });
    
    // Progress display
    function showProgress() {
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressStatus = document.getElementById('progressStatus');
        const submitBtn = document.getElementById('submitBtn');
        
        progressContainer.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Uploading...</span>';
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            
            if (progress >= 100) {
                clearInterval(interval);
                progressStatus.textContent = 'Completed!';
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    showResults();
                }, 1000);
            }
        }, 100);
    }
    
    // Results display
    function showResults() {
        const resultsSection = document.getElementById('resultsSection');
        const successCount = document.getElementById('successCount');
        const errorCount = document.getElementById('errorCount');
        const totalCount = document.getElementById('totalCount');
        const resultsContent = document.getElementById('resultsContent');
        
        // Simulate results (in real implementation, this would come from server response)
        const total = selectedStudents.length;
        const success = Math.floor(total * 0.9); // 90% success rate
        const errors = total - success;
        
        successCount.textContent = success;
        errorCount.textContent = errors;
        totalCount.textContent = total;
        
        resultsContent.innerHTML = `
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                Successfully uploaded ${success} scores
            </div>
            ${errors > 0 ? `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${errors} scores had errors and were not processed
                </div>
            ` : ''}
        `;
        
        resultsSection.style.display = 'block';
        
        if (errors === 0) {
            const modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();
        } else {
            const modal = new bootstrap.Modal(document.getElementById('errorModal'));
            document.getElementById('errorDetails').innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                ${errors} scores could not be processed due to validation errors.
            `;
            modal.show();
        }
    }
    
    // Clear form
    function clearForm() {
        selectedStudents = [];
        updateStudentSelection();
        updateScoresCount();
        
        document.getElementById('id_scores').value = '';
        document.getElementById('id_remarks').value = '';
        
        document.querySelectorAll('.form-control, .form-select').forEach(field => {
            field.classList.remove('is-valid', 'is-invalid');
        });
        
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'none';
        
        showNotification('Form cleared successfully', 'info');
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + Enter to submit
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('bulkScoreForm').requestSubmit();
        }
        
        // Ctrl + K to clear
        if (e.ctrlKey && e.key === 'k') {
            e.preventDefault();
            clearForm();
        }
    });
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Hover effects
    document.querySelectorAll('.student-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            if (!this.classList.contains('selected')) {
                this.style.transform = 'translateY(-3px) scale(1.02)';
            }
        });
        
        item.addEventListener('mouseleave', function() {
            if (!this.classList.contains('selected')) {
                this.style.transform = 'translateY(0) scale(1)';
            }
        });
    });
    
    // Show notification
    function showNotification(message, type) {
        // You can implement a toast notification here
        console.log(`${type}: ${message}`);
    }
</script>
{% endblock %}