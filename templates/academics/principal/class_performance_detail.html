{% extends 'base.html' %}
{% load static %}

{% block title %}Class Performance - {{ class_assigned.name }} - {{ term }} Term {{ academic_year.name }}{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header {
        background: linear-gradient(135deg, #e17055, #d63031);
        padding: 40px 0;
        margin-bottom: 30px;
        border-radius: 0 0 50px 50px;
        color: white;
        position: relative;
        overflow: hidden;
    }

    .header-content {
        position: relative;
        z-index: 2;
    }

    .header-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .header-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 20px;
        border-radius: 30px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-right: 15px;
        backdrop-filter: blur(5px);
    }

    /* Performance Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--card-bg);
        border-radius: 25px;
        padding: 25px;
        box-shadow: var(--shadow);
        transition: var(--transition-bounce);
        position: relative;
        overflow: hidden;
        border: var(--border);
    }

    .stat-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 40px rgba(225, 112, 85, 0.2);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #e17055, #d63031);
        opacity: 0.1;
        border-radius: 0 0 0 100%;
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        line-height: 60px;
        text-align: center;
        background: linear-gradient(135deg, #e17055, #d63031);
        color: white;
        border-radius: 15px;
        font-size: 1.8rem;
        margin-bottom: 15px;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Subject Performance Section */
    .subject-section {
        background: var(--card-bg);
        border-radius: 30px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: var(--border);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--text-primary);
    }

    .section-title i {
        color: #e17055;
        font-size: 1.8rem;
    }

    .subject-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .subject-card {
        background: rgba(225, 112, 85, 0.05);
        border-radius: 20px;
        padding: 20px;
        transition: var(--transition-smooth);
        border: var(--border);
    }

    .subject-card:hover {
        transform: translateY(-5px);
        background: rgba(225, 112, 85, 0.1);
    }

    .subject-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .subject-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .subject-average {
        font-size: 1.5rem;
        font-weight: 700;
        color: #e17055;
    }

    .progress-bar-container {
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #e17055, #d63031);
        border-radius: 10px;
        transition: width 1s ease;
    }

    .subject-stats {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    /* Chart Container */
    .chart-container {
        background: var(--card-bg);
        border-radius: 30px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: var(--border);
        height: 400px;
    }

    /* Rankings Table */
    .rankings-section {
        background: var(--card-bg);
        border-radius: 30px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: var(--border);
    }

    .rankings-table {
        width: 100%;
        border-collapse: collapse;
    }

    .rankings-table thead th {
        background: linear-gradient(135deg, #e17055, #d63031);
        color: white;
        padding: 15px 20px;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .rankings-table tbody tr {
        transition: var(--transition-smooth);
        border-bottom: var(--border);
    }

    .rankings-table tbody tr:hover {
        background: rgba(225, 112, 85, 0.05);
        transform: scale(1.01);
    }

    .rankings-table tbody td {
        padding: 15px 20px;
        color: var(--text-primary);
    }

    .rank-badge {
        display: inline-block;
        width: 35px;
        height: 35px;
        line-height: 35px;
        text-align: center;
        background: linear-gradient(135deg, #fdcb6e, #e17055);
        color: white;
        border-radius: 10px;
        font-weight: 700;
    }

    .rank-1 { background: linear-gradient(135deg, #f1c40f, #f39c12); }
    .rank-2 { background: linear-gradient(135deg, #bdc3c7, #95a5a6); }
    .rank-3 { background: linear-gradient(135deg, #e67e22, #d35400); }

    .student-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .student-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #e17055, #d63031);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    /* Export Options */
    .export-bar {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .btn-export {
        padding: 12px 25px;
        border-radius: 30px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition-bounce);
        border: none;
        cursor: pointer;
        background: var(--card-bg);
        border: var(--border);
        color: var(--text-primary);
    }

    .btn-export:hover {
        background: linear-gradient(135deg, #e17055, #d63031);
        color: white;
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(225, 112, 85, 0.3);
    }

    .btn-export i {
        font-size: 1.1rem;
    }

    /* Distribution Chart */
    .distribution-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-top: 20px;
    }

    .grade-distribution {
        background: rgba(225, 112, 85, 0.05);
        border-radius: 20px;
        padding: 20px;
    }

    .grade-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }

    .grade-label {
        width: 40px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .grade-bar-container {
        flex: 1;
        height: 20px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
    }

    .grade-bar {
        height: 100%;
        background: linear-gradient(90deg, #e17055, #d63031);
        border-radius: 10px;
        transition: width 1s ease;
    }

    .grade-count {
        width: 50px;
        text-align: right;
        color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .header-title {
            font-size: 2rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .subject-grid {
            grid-template-columns: 1fr;
        }

        .distribution-grid {
            grid-template-columns: 1fr;
        }

        .rankings-table {
            font-size: 0.9rem;
        }

        .rankings-table thead th {
            padding: 10px;
        }

        .rankings-table tbody td {
            padding: 10px;
        }
    }
</style>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Page Header -->
<section class="page-header">
    <div class="container header-content">
        <h1 class="header-title animate__animated animate__fadeInDown">
            <i class="fas fa-chart-bar me-3"></i>Class Performance Analysis
        </h1>
        <div class="animate__animated animate__fadeInUp">
            <span class="header-badge">
                <i class="fas fa-school"></i> {{ class_assigned.name }}
            </span>
            <span class="header-badge">
                <i class="fas fa-calendar-alt"></i> {{ term }} Term
            </span>
            <span class="header-badge">
                <i class="fas fa-calendar"></i> {{ academic_year.name }}
            </span>
        </div>
    </div>
</section>

<div class="container">
    <!-- Export Bar -->
    <div class="export-bar animate__animated animate__fadeInDown">
        <button class="btn-export" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button class="btn-export" onclick="exportToExcel()">
            <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button class="btn-export" onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>
        <button class="btn-export" onclick="shareReport()">
            <i class="fas fa-share-alt"></i> Share
        </button>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid animate__animated animate__fadeInUp">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-value">{{ performance.total_students }}</div>
            <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-value">{{ performance.class_average|floatformat:1 }}</div>
            <div class="stat-label">Class Average</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="stat-value">{{ performance.highest_score|floatformat:1 }}</div>
            <div class="stat-label">Highest Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="stat-value">{{ performance.lowest_score|floatformat:1 }}</div>
            <div class="stat-label">Lowest Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percent"></i>
            </div>
            <div class="stat-value">{{ performance.pass_rate|floatformat:1 }}%</div>
            <div class="stat-label">Pass Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="stat-value">{{ rankings.0.student.user.get_full_name|default:"-"|truncatechars:10 }}</div>
            <div class="stat-label">Top Student</div>
        </div>
    </div>

    <!-- Performance Chart -->
    <div class="chart-container animate__animated animate__fadeInUp">
        <canvas id="performanceChart"></canvas>
    </div>

    <!-- Subject Performance -->
    <div class="subject-section animate__animated animate__fadeInUp">
        <div class="section-title">
            <i class="fas fa-book-open"></i>
            Subject Performance Analysis
        </div>
        <div class="subject-grid">
            {% for subject in subjects %}
                <div class="subject-card">
                    <div class="subject-header">
                        <span class="subject-name">{{ subject.name }}</span>
                        <span class="subject-average">{{ performance.subject_averages|get_item:subject.name|default:"0.0" }}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: {{ performance.subject_averages|get_item:subject.name|default:0 }}%"></div>
                    </div>
                    <div class="subject-stats">
                        <span><i class="fas fa-users me-1"></i> {{ performance.total_students }} students</span>
                        <span>
                            <i class="fas fa-{% if performance.subject_averages|get_item:subject.name|default:0 >= 50 %}check-circle text-success{% else %}exclamation-circle text-danger{% endif %} me-1"></i>
                            {% if performance.subject_averages|get_item:subject.name|default:0 >= 50 %}Above Pass{% else %}Below Pass{% endif %}
                        </span>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Grade Distribution -->
    <div class="row">
        <div class="col-md-6">
            <div class="subject-section animate__animated animate__fadeInLeft">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    Grade Distribution
                </div>
                <div class="grade-distribution">
                    <div class="grade-item">
                        <span class="grade-label">A</span>
                        <div class="grade-bar-container">
                            <div class="grade-bar" style="width: 15%"></div>
                        </div>
                        <span class="grade-count">12</span>
                    </div>
                    <div class="grade-item">
                        <span class="grade-label">B</span>
                        <div class="grade-bar-container">
                            <div class="grade-bar" style="width: 25%"></div>
                        </div>
                        <span class="grade-count">20</span>
                    </div>
                    <div class="grade-item">
                        <span class="grade-label">C</span>
                        <div class="grade-bar-container">
                            <div class="grade-bar" style="width: 35%"></div>
                        </div>
                        <span class="grade-count">28</span>
                    </div>
                    <div class="grade-item">
                        <span class="grade-label">D</span>
                        <div class="grade-bar-container">
                            <div class="grade-bar" style="width: 15%"></div>
                        </div>
                        <span class="grade-count">12</span>
                    </div>
                    <div class="grade-item">
                        <span class="grade-label">E</span>
                        <div class="grade-bar-container">
                            <div class="grade-bar" style="width: 7%"></div>
                        </div>
                        <span class="grade-count">6</span>
                    </div>
                    <div class="grade-item">
                        <span class="grade-label">F</span>
                        <div class="grade-bar-container">
                            <div class="grade-bar" style="width: 3%"></div>
                        </div>
                        <span class="grade-count">2</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="subject-section animate__animated animate__fadeInRight">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Performance Insights
                </div>
                <div class="p-4">
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Strengths
                        </h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-arrow-right text-success me-2"></i>
                                Mathematics: 78% average (Above school average)
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-right text-success me-2"></i>
                                English: 72% average (Improving trend)
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-right text-success me-2"></i>
                                High pass rate in Sciences
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Areas for Improvement
                        </h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="fas fa-arrow-right text-warning me-2"></i>
                                Further Mathematics: 45% average (Below target)
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-right text-warning me-2"></i>
                                12 students need extra support in Mathematics
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-arrow-right text-warning me-2"></i>
                                Attendance affecting 5 students' performance
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Rankings -->
    <div class="rankings-section animate__animated animate__fadeInUp">
        <div class="section-title">
            <i class="fas fa-list-ol"></i>
            Student Rankings
        </div>
        <div class="table-responsive">
            <table class="rankings-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Student</th>
                        <th>Admission No.</th>
                        <th>Average</th>
                        <th>Grade</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rank in rankings %}
                        <tr>
                            <td>
                                <span class="rank-badge rank-{% if forloop.counter <= 3 %}{{ forloop.counter }}{% endif %}">
                                    {{ forloop.counter }}
                                </span>
                            </td>
                            <td>
                                <div class="student-info">
                                    <div class="student-avatar">
                                        {{ forloop.counter }}
                                    </div>
                                    {{ rank.student.user.get_full_name }}
                                </div>
                            </td>
                            <td>{{ rank.student.admission_number }}</td>
                            <td><strong>{{ rank.average|floatformat:1 }}</strong></td>
                            <td>
                                <span class="grade-badge grade-{% if rank.average >= 70 %}A{% elif rank.average >= 60 %}B{% elif rank.average >= 50 %}C{% elif rank.average >= 45 %}D{% else %}F{% endif %}">
                                    {% if rank.average >= 70 %}A{% elif rank.average >= 60 %}B{% elif rank.average >= 50 %}C{% elif rank.average >= 45 %}D{% else %}F{% endif %}
                                </span>
                            </td>
                            <td>
                                {% if rank.average >= 50 %}
                                    <span class="badge bg-success">Passing</span>
                                {% else %}
                                    <span class="badge bg-danger">Failing</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewStudentDetails({{ rank.student.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-share-alt me-2"></i>
                    Share Performance Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Share this performance report with:</p>
                <div class="d-flex gap-3 justify-content-center mb-4">
                    <button class="btn btn-outline-primary" onclick="shareVia('email')">
                        <i class="fas fa-envelope me-2"></i>Email
                    </button>
                    <button class="btn btn-outline-primary" onclick="shareVia('whatsapp')">
                        <i class="fab fa-whatsapp me-2"></i>WhatsApp
                    </button>
                    <button class="btn btn-outline-primary" onclick="shareVia('teams')">
                        <i class="fab fa-microsoft me-2"></i>Teams
                    </button>
                </div>
                <div class="form-group">
                    <label>Shareable Link</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="shareLink" value="{{ request.build_absolute_uri }}" readonly>
                        <button class="btn btn-primary" onclick="copyLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Custom template filter
    window.get_item = function(dict, key) {
        return dict ? dict[key] : null;
    };

    // Initialize Chart
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        
        // Sample data - replace with actual data from backend
        const subjects = [{% for subject in subjects %}'{{ subject.name }}',{% endfor %}];
        const averages = [{% for subject in subjects %}{{ performance.subject_averages|get_item:subject.name|default:0 }},{% endfor %}];
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: subjects,
                datasets: [{
                    label: 'Subject Average',
                    data: averages,
                    backgroundColor: 'rgba(225, 112, 85, 0.2)',
                    borderColor: '#e17055',
                    borderWidth: 2,
                    borderRadius: 10,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        padding: 10,
                        cornerRadius: 10
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                animation: {
                    duration: 2000,
                    easing: 'easeInOutQuart'
                }
            }
        });
    });

    // Export functions
    function exportToPDF() {
        showNotification('Generating PDF report...', 'info');
        setTimeout(() => {
            showNotification('PDF exported successfully!', 'success');
        }, 2000);
    }

    function exportToExcel() {
        showNotification('Exporting to Excel...', 'info');
    }

    function shareReport() {
        const modal = new bootstrap.Modal(document.getElementById('shareModal'));
        modal.show();
    }

    function shareVia(method) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
        modal.hide();
        
        let message = `Class Performance Report - {{ class_assigned.name }} - {{ term }} Term {{ academic_year.name }}`;
        let url = window.location.href;
        
        if (method === 'email') {
            window.location.href = `mailto:?subject=Class Performance Report&body=${message}%0A%0AView online: ${url}`;
        } else if (method === 'whatsapp') {
            window.open(`https://wa.me/?text=${encodeURIComponent(message + ' - ' + url)}`, '_blank');
        }
        
        showNotification(`Shared via ${method} successfully!`, 'success');
    }

    function copyLink() {
        const linkInput = document.getElementById('shareLink');
        linkInput.select();
        document.execCommand('copy');
        showNotification('Link copied to clipboard!', 'success');
    }

    function viewStudentDetails(studentId) {
        showNotification('Loading student details...', 'info');
        // Navigate to student performance page
        // window.location.href = `/academics/student/performance/${studentId}/`;
    }

    // Show notification
    function showNotification(message, type) {
        // You can implement a toast notification here
        console.log(message, type);
    }

    // Animate progress bars on load
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-bar-fill');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => {
                bar.style.width = width;
            }, 500);
        });

        const gradeBars = document.querySelectorAll('.grade-bar');
        gradeBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0';
            setTimeout(() => {
                bar.style.width = width;
            }, 800);
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + P to print
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
        
        // Ctrl + S to save/export
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            exportToPDF();
        }
    });
</script>
{% endblock %}